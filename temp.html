<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reusable Stacked Bar Chart with Tooltip</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .bar {
            shape-rendering: crispEdges;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-size: 10px;
        }

        .legend rect {
            stroke-width: 1;
            stroke: rgba(0, 0, 0, 0.2);
        }

        .legend text {
            font-size: 12px;
        }

        .tooltip {
            position: absolute;
            padding: 5px 10px;
            background: white;
            border: 1px solid #ccc;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>

<svg id="stacked-bar-chart"></svg>
<div class="tooltip" id="tooltip"></div>

<script>
    function drawStackedBarChart({ svgId, data, keys, width = 600, height = 400, margin = { top: 20, right: 30, bottom: 40, left: 50 } }) {
        const svg = d3.select(`#${svgId}`)
            .attr("width", width)
            .attr("height", height)
            .html("") // clear existing content
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const stack = d3.stack().keys(keys);
        const stackedData = stack(data);

        const xScale = d3.scaleBand()
            .domain(data.map(d => d.category))
            .range([0, innerWidth])
            .padding(0.2);

        const yScale = d3.scaleLinear()
            .domain([0, d3.max(stackedData[stackedData.length - 1], d => d[1])])
            .nice()
            .range([innerHeight, 0]);

        const colorScale = d3.scaleOrdinal()
            .domain(keys)
            .range(d3.schemeCategory10);

        // Tooltip
        const tooltip = d3.select("#tooltip");

        // Axes
        svg.append("g")
            .attr("transform", `translate(0,${innerHeight})`)
            .call(d3.axisBottom(xScale));

        svg.append("g")
            .call(d3.axisLeft(yScale));

        // Bars
        const groups = svg.selectAll("g.layer")
            .data(stackedData)
            .enter().append("g")
            .attr("class", "layer")
            .style("fill", d => colorScale(d.key));

        groups.selectAll("rect")
            .data(d => d.map(p => ({ ...p, key: d.key })))
            .enter().append("rect")
            .attr("x", d => xScale(d.data.category))
            .attr("y", d => yScale(d[1]))
            .attr("height", d => yScale(d[0]) - yScale(d[1]))
            .attr("width", xScale.bandwidth())
            .on("mouseover", (event, d) => {
                tooltip.transition().style("opacity", 1);
                tooltip.html(`Category: <b>${d.data.category}</b><br>${d.key}: <b>${d.data[d.key]}</b>`);
            })
            .on("mousemove", (event) => {
                tooltip.style("left", (event.pageX + 10) + "px")
                       .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => {
                tooltip.transition().style("opacity", 0);
            });

        // Legend
        const legend = svg.selectAll(".legend")
            .data(keys.slice().reverse())
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", (d, i) => `translate(0,${i * 20})`);

        legend.append("rect")
            .attr("x", innerWidth - 18)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", colorScale);

        legend.append("text")
            .attr("x", innerWidth - 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "end")
            .text(d => d);
    }

    // Example usage
    const data = [
        { category: "A", value1: 10, value2: 20, value3: 15 },
        { category: "B", value1: 15, value2: 25, value3: 10 },
        { category: "C", value1: 20, value2: 10, value3: 25 }
    ];

    const keys = ["value1", "value2", "value3"];

    drawStackedBarChart({
        svgId: "stacked-bar-chart",
        data: data,
        keys: keys,
        width: 500,
        height: 400
    });
</script>
</body>
</html>
